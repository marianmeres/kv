# @marianmeres/kv - LLM Context Document

## Package Identity

- Name: @marianmeres/kv
- Version: 1.2.1
- Description: Key-value storage abstraction layer with multiple backend adapters
- Main Export: ./src/mod.ts
- License: MIT
- Repository: https://github.com/marianmeres/kv
- Runtime: Deno (primary), Node.js (via npm build)

## Architecture Overview

This package provides a unified key-value storage API across four distinct storage backends using an adapter pattern. A single factory function creates adapter instances that share a consistent interface.

### File Structure

```
src/
├── mod.ts                    # Main entry, re-exports from kv.ts
├── kv.ts                     # Factory function createKVClient()
├── adapter/
│   ├── abstract.ts           # Base class AdapterAbstract and types
│   ├── memory.ts             # AdapterMemory - JavaScript Map storage
│   ├── redis.ts              # AdapterRedis - Redis client wrapper
│   ├── postgres.ts           # AdapterPostgres - PostgreSQL JSONB storage
│   └── deno-kv.ts            # AdapterDenoKv - Deno.Kv wrapper
└── utils/
    └── sleep.ts              # Utility for tests
tests/
├── kv.test.ts                # Main test suite
├── _tests-runner.ts          # Test orchestration
├── _redis.ts                 # Redis connection helper
└── _pg.ts                    # PostgreSQL connection helper
```

## Core Types and Interfaces

### AdapterType

```typescript
type AdapterType = "memory" | "redis" | "postgres" | "deno-kv"
```

### SetOptions

```typescript
interface SetOptions extends Record<string, any> {
  ttl: number  // Time-to-live in seconds
}
```

### Operation (for transactions)

```typescript
interface Operation {
  type: "set" | "get" | "delete"
  key: string
  value?: any                     // For "set" operations
  options?: Partial<SetOptions>   // For "set" operations
}
```

### AdapterAbstractOptions

```typescript
interface AdapterAbstractOptions extends Record<string, any> {
  defaultTtl: number   // Default TTL in seconds (0 = no default)
  logger?: Logger      // Optional @marianmeres/clog instance
}
```

### AdapterInfo

```typescript
interface AdapterInfo {
  type: AdapterType
}
```

## Factory Function

```typescript
function createKVClient<T extends AdapterType>(
  namespace: string,
  type?: T,
  options?: AdapterOptionsFor<T>
): AdapterFor<T>
```

- `namespace`: Key prefix. Must end with `:` or be empty string `""`
- `type`: Adapter type. Default: `"memory"`
- `options`: Adapter-specific options

## Complete API Reference

### Lifecycle Methods

```typescript
initialize(): Promise<void>
destroy(hard?: boolean): Promise<void>
```

- `initialize()`: Connect to backend, create tables (PostgreSQL), etc.
- `destroy(hard)`: Cleanup resources. `hard=true` drops table in PostgreSQL.

### Single Key Operations

```typescript
set(key: string, value: any, options?: Partial<SetOptions>): Promise<boolean>
get(key: string): Promise<any>
exists(key: string): Promise<boolean>
delete(key: string): Promise<boolean>
expire(key: string, ttl: number): Promise<boolean>
ttl(key: string): Promise<Date | null | false>
```

- `set()`: Store value with optional TTL. Returns true on success.
- `get()`: Retrieve value. Returns null for missing/expired keys.
- `exists()`: Check key exists and not expired.
- `delete()`: Remove key. Returns true if existed (except Deno KV).
- `expire()`: Set TTL on existing key. Returns true if key existed.
- `ttl()`: Get expiration. Returns Date, null (no TTL), or false (missing).

### Pattern & Bulk Operations

```typescript
keys(pattern: string): Promise<string[]>
clear(pattern: string): Promise<number>
setMultiple(pairs: [string, any][], options?: Partial<SetOptions>): Promise<boolean[]>
getMultiple(keys: string[]): Promise<Record<string, any>>
```

- `keys(pattern)`: Redis wildcard syntax (`*`, `?`). Returns sorted array.
- `clear(pattern)`: Delete matching keys. Returns deletion count.
- `setMultiple()`: Batch set. Returns array of success booleans.
- `getMultiple()`: Batch get. Missing keys have null value.

### Transaction Operations

```typescript
transaction(operations: Operation[]): Promise<any[]>
```

- Executes operations atomically (Redis, PostgreSQL) or sequentially (Memory, Deno KV).

### Metadata

```typescript
info(): AdapterInfo
__debug_dump(): Promise<Record<string, { value: any; ttl: Date | null | false }>>
```

## Adapter-Specific Configuration

### Memory Adapter

```typescript
interface AdapterMemoryOptions extends AdapterAbstractOptions {
  ttlCleanupIntervalSec: number  // Default: 0 (disabled)
}
```

- Uses JavaScript Map internally
- Non-persistent
- Lazy TTL checking + optional background cleanup timer

### Redis Adapter

```typescript
interface AdapterRedisOptions extends AdapterAbstractOptions {
  db: RedisClient | RedisClientPool  // Required
  isCluster: boolean                  // Default: false
}
```

- Namespace is REQUIRED (cannot be empty)
- Uses Redis MULTI for atomic transactions
- `keys()` and `clear()` throw in cluster mode

### PostgreSQL Adapter

```typescript
interface AdapterPostgresOptions extends AdapterAbstractOptions {
  db: pg.Pool | pg.Client           // Required
  tableName: string                  // Default: "__kv"
  ttlCleanupIntervalSec: number     // Default: 0
}
```

- Auto-creates table with schema:
  - `key VARCHAR(512) PRIMARY KEY`
  - `value JSONB NOT NULL`
  - `expires_at TIMESTAMP WITH TIME ZONE`
  - `created_at`, `updated_at` timestamps
  - Index on `expires_at` column
- Uses `BEGIN/COMMIT/ROLLBACK` for transactions

### Deno KV Adapter

```typescript
interface AdapterDenoKvOptions extends AdapterAbstractOptions {
  db: Deno.Kv  // Required
}
```

- LIMITATIONS:
  - `delete()` always returns true
  - `expire()` not supported (returns false)
  - `ttl()` not supported (returns null)
  - TTL only settable at `set()` time, not queryable after
- Deno runtime only

## Key Implementation Details

### Serialization

All adapters JSON stringify/parse values:
```typescript
// Write
JSON.stringify(value ?? null)
// Read
JSON.parse(stored)
```

- `undefined` becomes `null`
- Non-serializable values (functions, circular refs) will fail

### Namespace Handling

```typescript
_withNs(key): namespace + key
_withoutNs(key): key.slice(namespace.length)
```

### Pattern Matching Conversion

| Backend | `*` becomes | `?` becomes |
|---------|-------------|-------------|
| Memory/Deno KV | `.*` (regex) | `.` (regex) |
| PostgreSQL | `%` (LIKE) | `_` (LIKE) |
| Redis | native | native |

### TTL Storage by Adapter

| Adapter | TTL Storage | Cleanup |
|---------|-------------|---------|
| Memory | `Map<string, Date>` | Lazy + optional timer |
| Redis | Native EXPIRE | Redis automatic |
| PostgreSQL | `expires_at` column | Query filter + optional timer |
| Deno KV | `expireIn` ms | Deno KV automatic |

## Dependencies

- `redis@^5.10.0` - Redis client (npm)
- `pg@^8.16.3` - PostgreSQL client (npm)
- `@types/pg@^8.15.6` - TypeScript types
- `@marianmeres/clog@^3.2.2` - Logging (jsr)
- `@std/assert`, `@std/fs`, `@std/path` - Deno standard library

## Testing

```bash
deno test --unstable-kv -A --env-file --watch
```

Environment variables:
- `TEST_REDIS_URL` - Redis connection (default: redis://localhost:6379)
- `TEST_PG_HOST`, `TEST_PG_USER`, `TEST_PG_PASSWORD`, `TEST_PG_DATABASE`, `TEST_PG_PORT`

## Build (NPM Distribution)

```bash
deno task npm:build
deno task npm:publish
```

Outputs to `.npm-dist/` with:
- Transpiled JavaScript
- TypeScript declarations
- package.json with peer dependencies

## Common Usage Patterns

### Basic Memory Usage
```typescript
const client = createKVClient("app:");
await client.initialize();
await client.set('key', { value: 1 });
const data = await client.get('key');
await client.destroy();
```

### With TTL
```typescript
await client.set('session', data, { ttl: 3600 });  // 1 hour
const expires = await client.ttl('session');        // Date object
await client.expire('session', 7200);               // Extend to 2 hours
```

### Batch Operations
```typescript
await client.setMultiple([['k1', v1], ['k2', v2]]);
const results = await client.getMultiple(['k1', 'k2']);
```

### Pattern Matching
```typescript
const keys = await client.keys('user:*');
const deleted = await client.clear('temp:*');
```

### Transactions
```typescript
const results = await client.transaction([
  { type: 'get', key: 'counter' },
  { type: 'set', key: 'counter', value: 42 },
]);
```

## Adapter Feature Matrix

| Feature | Memory | Redis | PostgreSQL | Deno KV |
|---------|:------:|:-----:|:----------:|:-------:|
| Persistent | - | + | + | + |
| Distributed | - | + | + | + |
| Atomic Transactions | - | + | + | - |
| TTL Query | + | + | + | - |
| TTL Modify | + | + | + | - |
| Pattern Ops | + | +* | + | + |
| Empty Namespace | + | - | + | + |

*Redis: Pattern ops not available in cluster mode
